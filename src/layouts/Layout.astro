---
interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Carlos Orbegoso - Backend Developer & Java Specialist",
  description = "Backend Developer especializado en Java, Spring Boot y Quarkus. Experiencia en microservicios y arquitecturas cloud."
} = Astro.props;
---

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#64B5F6">
    <title>{title}</title>
    <meta name="description" content={description}>

    <!-- SEO Meta Tags -->
    <meta name="author" content="Carlos Orbegoso">
    <meta name="keywords" content="Backend Developer, Java, Spring Boot, Quarkus, Microservices, Cloud Native, Software Engineer">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://carlosorbegoso.dev">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://carlosorbegoso.dev">
    <meta property="og:title" content={title}>
    <meta property="og:description" content={description}>
    <meta property="og:image" content="https://carlosorbegoso.dev/og-image.jpg">
    <meta property="og:locale" content="es_ES">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://carlosorbegoso.dev">
    <meta name="twitter:title" content={title}>
    <meta name="twitter:description" content={description}>
    <meta name="twitter:image" content="https://carlosorbegoso.dev/og-image.jpg">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.svg">

    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "Carlos Orbegoso",
        "url": "https://carlosorbegoso.dev",
        "image": "https://carlosorbegoso.dev/og-image.jpg",
        "jobTitle": "Backend Developer",
        "worksFor": {
            "@type": "Organization",
            "name": "Tata Consultancy Services"
        },
        "sameAs": [
            "https://github.com/carlosorbegoso",
            "https://linkedin.com/in/carlos-orbergoso-loayza"
        ],
        "knowsAbout": ["Java", "Spring Boot", "Quarkus", "Microservices", "Cloud Native", "Backend Development"]
    }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Loader styles -->
    <style>
        .page-loader {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0d1117 0%, #1a1a2e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .page-loader.loaded {
            opacity: 0;
            visibility: hidden;
        }
        .loader-content {
            text-align: center;
        }
        .loader-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
            position: relative;
        }
        .loader-ring {
            position: absolute;
            inset: 0;
            border: 3px solid transparent;
            border-top-color: #64B5F6;
            border-radius: 50%;
            animation: loaderSpin 1s linear infinite;
        }
        .loader-ring:nth-child(2) {
            inset: 8px;
            border-top-color: #FF6B35;
            animation-duration: 1.5s;
            animation-direction: reverse;
        }
        .loader-ring:nth-child(3) {
            inset: 16px;
            border-top-color: #00ffff;
            animation-duration: 2s;
        }
        .loader-icon {
            position: absolute;
            inset: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64B5F6;
            font-size: 1.5rem;
        }
        .loader-text {
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .loader-subtext {
            color: #b0b0b0;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
        }
        .loader-progress {
            width: 200px;
            height: 4px;
            background: rgba(100, 181, 246, 0.2);
            border-radius: 2px;
            margin-top: 1.5rem;
            overflow: hidden;
        }
        .loader-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #64B5F6, #FF6B35);
            border-radius: 2px;
            animation: loaderProgress 2s ease-out forwards;
        }
        @keyframes loaderSpin {
            to { transform: rotate(360deg); }
        }
        @keyframes loaderProgress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Page Loader -->
    <div class="page-loader" id="page-loader">
        <div class="loader-content">
            <div class="loader-logo">
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-icon">
                    <i class="fas fa-code"></i>
                </div>
            </div>
            <div class="loader-text">Carlos Orbegoso</div>
            <div class="loader-subtext">Loading experience...</div>
            <div class="loader-progress">
                <div class="loader-progress-bar"></div>
            </div>
        </div>
    </div>
    <!-- Contenedor para efectos visuales Three.js -->
    <div id="visual-effects-container" class="visual-effects-container"></div>

    <!-- Main Content -->
    <slot />

    <!-- Scripts de inicialización -->
    <script>
        import '../styles/main.css';
        import { CONFIG } from '../scripts/config/config.js';
        import { log } from '../scripts/utils/logger.js';
        import { DOM, Events, Performance } from '../scripts/utils/helpers.js';
        import { VisualEffectsEngine } from '../scripts/engines/visual-effects-engine.js';
        import { NeuralSystemEngine } from '../scripts/engines/neural-system/NeuralSystemEngine.js';
        import { HeroThreeEngine } from '../scripts/engines/hero-three-engine.js';
        import { DeviceDetector } from '../scripts/utils/device-detector.js';
        import { MobileMenuManager } from '../scripts/utils/mobile-menu.js';
        import { HeroAnimations } from '../scripts/utils/hero-animations.js';
        import { AboutAnimations } from '../scripts/utils/about-animations.js';

        class Portfolio {
            constructor() {
                this.isInitialized = false;
                this.modules = new Map();
                this.visualEngine = null;
                this.brainEngine = null;
                this.heroEngine = null;
                this.deviceDetector = null;
                this.mobileMenuManager = null;
                this.heroAnimations = null;
                this.aboutAnimations = null;
            }

            async init() {
                try {
                    await this.initializeBasicModules();
                    this.setupBasicFeatures();
                    await this.initializeAdvancedModules();
                    this.setupGlobalEvents();
                    this.isInitialized = true;
                    log.info('Portfolio inicializado');
                } catch (error) {
                    console.error('Error inicializando portfolio:', error);
                }
            }

            async initializeBasicModules() {
                this.deviceDetector = new DeviceDetector();
                this.mobileMenuManager = new MobileMenuManager();
                this.heroAnimations = new HeroAnimations();
                this.aboutAnimations = new AboutAnimations();
            }

            async initializeAdvancedModules() {
                try {
                    this.visualEngine = new VisualEffectsEngine();
                    const currentTheme = localStorage.getItem('theme') || CONFIG.THEMES.DEFAULT;
                    this.visualEngine.updateTheme(currentTheme);
                    this.initializeSectionEffects();
                } catch (error) {
                    log.error('Error inicializando motor visual:', error);
                }

                try {
                    this.heroEngine = new HeroThreeEngine();
                    await this.heroEngine.init('hero-particles');
                } catch (error) {
                    log.error('Error inicializando Hero Three.js Engine:', error);
                }

                // Inicializar cerebro anatómico épico como fondo
                try {
                    console.log('Creando NeuralSystemEngine (Cerebro Anatómico Épico)...');
                    this.brainEngine = new NeuralSystemEngine('visual-effects-container');
                } catch (error) {
                    console.error('Error creando cerebro épico:', error);
                }
            }

            initializeSectionEffects() {
                if (!this.visualEngine) return;

                const sections = [
                    { name: 'Hero', containerId: 'hero-effects' },
                    { name: 'About', containerId: 'about-effects' },
                    { name: 'Experience', containerId: 'experience-effects' },
                    { name: 'Skills', containerId: 'skills-effects' },
                    { name: 'Projects', containerId: 'projects-effects' },
                    { name: 'Contact', containerId: 'contact-effects' }
                ];

                sections.forEach(section => {
                    const sectionElement = document.getElementById(section.name.toLowerCase());
                    if (sectionElement) {
                        this.visualEngine.initSectionEffects(section.name, section.containerId);
                    }
                });

                this.setupSectionEffectsObserver();
            }

            setupSectionEffectsObserver() {
                const sections = ['hero', 'about', 'experience', 'skills', 'projects', 'contact'];

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('section-effects-active');
                        }
                    });
                }, { threshold: 0.1, rootMargin: '0px 0px -100px 0px' });

                sections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) observer.observe(section);
                });
            }

            setupBasicFeatures() {
                this.setupThemeToggle();
                this.setupMobileMenu();
                this.setupSmoothScrolling();
                this.setupLanguageToggle();
                this.setupMobileOptimizations();
                this.setupTouchInteractions();
            }

            setupThemeToggle() {
                const themeToggle = DOM.select('#theme-toggle');
                if (!themeToggle) return;

                const currentTheme = localStorage.getItem('theme') || CONFIG.THEMES.DEFAULT;
                document.documentElement.setAttribute('data-theme', currentTheme);
                this.updateThemeIcon(currentTheme);

                Events.on(themeToggle, 'click', () => {
                    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    this.updateThemeIcon(newTheme);

                    if (this.visualEngine) this.visualEngine.updateTheme(newTheme);
                    if (this.heroEngine) this.heroEngine.updateTheme(newTheme);

                    Events.trigger(window, 'themeChanged', { theme: newTheme });
                });
            }

            updateThemeIcon(theme) {
                const themeIcon = DOM.select('#theme-toggle i');
                if (themeIcon) {
                    themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                }
            }

            setupMobileMenu() {
                const menuToggle = DOM.select('#menu-toggle');
                const navLinks = DOM.select('.nav-links');
                if (!menuToggle || !navLinks) return;

                Events.on(menuToggle, 'click', () => {
                    DOM.toggleClass(navLinks, 'active');
                    DOM.toggleClass(menuToggle, 'active');
                    document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : '';
                });

                DOM.selectAll('.nav-link').forEach(link => {
                    Events.on(link, 'click', () => {
                        DOM.removeClasses(navLinks, 'active');
                        DOM.removeClasses(menuToggle, 'active');
                        document.body.style.overflow = '';
                    });
                });

                Events.on(document, 'click', (e) => {
                    if (!menuToggle.contains(e.target) && !navLinks.contains(e.target)) {
                        DOM.removeClasses(navLinks, 'active');
                        DOM.removeClasses(menuToggle, 'active');
                        document.body.style.overflow = '';
                    }
                });
            }

            setupSmoothScrolling() {
                DOM.selectAll('a[href^="#"]').forEach(anchor => {
                    Events.on(anchor, 'click', (e) => {
                        e.preventDefault();
                        const target = DOM.select(anchor.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                });
            }

            setupLanguageToggle() {
                const languageToggle = DOM.select('#language-toggle');
                if (!languageToggle) return;

                const currentLanguage = localStorage.getItem('language') || CONFIG.LANGUAGES.DEFAULT;
                document.documentElement.setAttribute('data-language', currentLanguage);

                Events.on(languageToggle, 'click', () => {
                    const newLanguage = localStorage.getItem('language') === 'en' ? 'es' : 'en';
                    localStorage.setItem('language', newLanguage);
                    document.documentElement.setAttribute('data-language', newLanguage);
                    Events.trigger(window, 'languageChanged', { language: newLanguage });
                });
            }

            setupMobileOptimizations() {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) DOM.addClasses(document.body, 'mobile-device');

                const isTablet = window.innerWidth <= CONFIG.BREAKPOINTS.TABLET && window.innerWidth > CONFIG.BREAKPOINTS.MOBILE;
                if (isTablet) DOM.addClasses(document.body, 'tablet-device');
            }

            setupTouchInteractions() {
                const interactiveElements = DOM.selectAll('.btn, .tech-badge, .nav-link, .card');
                interactiveElements.forEach(element => {
                    Events.on(element, 'touchstart', () => { element.style.transform = 'scale(0.95)'; });
                    Events.on(element, 'touchend', () => { element.style.transform = ''; });
                    Events.on(element, 'touchcancel', () => { element.style.transform = ''; });
                });
            }

            setupGlobalEvents() {
                Events.on(document, 'visibilitychange', () => {
                    // Pausar/reanudar animaciones según visibilidad
                });

                Events.on(window, 'resize', Performance.throttle(() => {
                    // Manejar resize
                }, 100));

                Events.on(document, 'keydown', (e) => {
                    if (e.key === 'Escape') {
                        const navLinks = DOM.select('.nav-links');
                        const menuToggle = DOM.select('#menu-toggle');
                        if (navLinks?.classList.contains('active')) {
                            DOM.removeClasses(navLinks, 'active');
                            DOM.removeClasses(menuToggle, 'active');
                        }
                    }
                    if (e.key === 't' && e.ctrlKey) {
                        e.preventDefault();
                        DOM.select('#theme-toggle')?.click();
                    }
                });
            }
        }

        // Hide loader when page is ready
        const hideLoader = () => {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.classList.add('loaded');
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }
        };

        // Setup scroll progress indicator
        const setupScrollProgress = () => {
            const progressBar = document.querySelector('[data-header-progress]');
            if (!progressBar) return;

            window.addEventListener('scroll', () => {
                const scrollTop = window.scrollY;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                const scrollPercent = (scrollTop / docHeight) * 100;
                progressBar.style.width = `${scrollPercent}%`;
            });
        };

        // Setup contact form
        const setupContactForm = () => {
            const form = document.getElementById('contact-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                submitBtn.disabled = true;

                // Simulate form submission (replace with actual endpoint)
                await new Promise(resolve => setTimeout(resolve, 1500));

                submitBtn.innerHTML = '<i class="fas fa-check"></i> Sent!';
                form.reset();

                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 2000);
            });
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const portfolio = new Portfolio();
            await portfolio.init();
            window.portfolio = portfolio;

            setupScrollProgress();
            setupContactForm();

            // Hide loader after everything is initialized
            setTimeout(hideLoader, 2000);
        });

        // Fallback: hide loader after max wait time
        window.addEventListener('load', () => {
            setTimeout(hideLoader, 2500);
        });
    </script>
</body>
</html>
